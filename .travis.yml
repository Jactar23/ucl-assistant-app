language: node_js
node_js:
  - lts/*
dist: trusty
cache: npm
install:
  - npm i -g npm@latest
  - export NODE_ENV=dev
  - npm ci
jobs:
  include:
    - stage: testing
      script:
        - npm run test
    - stage: deploy-branch
      if: branch != master
      script:
        - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
        - export RELEASE_CHANNEL=${$(echo ${BRANCH//[\/]/.} | tr '[:upper:]' '[:lower:]')//[^a-z^0-9^_^-^.]}
        - npx expo login -u $EXPO_USERNAME -p $EXPO_PASSWORD
        - npx expo publish --non-interactive --release-channel="dev.$RELEASE_CHANNEL"
        - echo "Updated expo release at https://exp.host/@$EXPO_USERNAME/ucl-assistant?release-channel=dev.$RELEASE_CHANNEL\"
    - stage: deploy-master
      if: branch = master
      script:
        - npx expo login -u $EXPO_USERNAME -p $EXPO_PASSWORD
        - npx expo publish --non-interactive
        - echo "Updated expo release at https://exp.host/@$EXPO_USERNAME/ucl-assistant"
